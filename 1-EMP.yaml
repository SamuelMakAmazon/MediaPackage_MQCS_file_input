AWSTemplateFormatVersion: '2010-09-09'
Description: 'MQAR Test Environment'

Parameters:
  ChannelName1:
    Type: String
    Default: 'ch1'
    Description: 'Channel Name 1'
  ChannelName2:
    Type: String
    Default: 'ch2'
    Description: 'Channel Name 2'
  ChannelName3:
    Type: String
    Default: 'ch3'
    Description: 'Channel Name 3'
  EndpointName1:
    Type: String
    Default: 'cmaf'
    Description: 'Endpoint Name 1'
  EndpointName2:
    Type: String
    Default: 'cmaf'
    Description: 'Endpoint Name 2'
  EndpointName3:
    Type: String
    Default: 'cmaf'
    Description: 'Endpoint Name 3'
  ChannelGroupName:
    Type: String
    Default: 'gp1'
    Description: 'Name for the MediaPackage v2 Channel Group'
    AllowedPattern: '^[a-zA-Z0-9_-]{1,256}$'
    ConstraintDescription: 'Channel group name must be alphanumeric and can include underscores and hyphens. Max length is 256 characters.'
  TimecodeBurninPrefix:
    Type: String
    Default: 'Channel_1_'
    Description: 'Prefix for the TimecodeBurninSettings'
  S3FilePathA:
    Type: String
    Default: 's3://bucket/slate_1080_5994p.mp4'
    Description: 'S3 file path for slate'
  S3FilePathB:
    Type: String
    Default: 's3://bucket/bbb_1080_5994p.mp4'
    Description: 'S3 file path for prod input'
    
Resources:
  MediaLiveInputA1:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub '${ChannelName1}-slate'
      Type: MP4_FILE
      Sources:
        - Url: !Sub '${S3FilePathA}'
      RoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/MediaLiveAccessRole

  MediaLiveInputB1:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub '${ChannelName1}-prod'
      Type: MP4_FILE
      Sources:
        - Url: !Sub '${S3FilePathB}'
      RoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/MediaLiveAccessRole

  # Add inputs for channel 2
  MediaLiveInputA2:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub '${ChannelName2}-slate'
      Type: MP4_FILE
      Sources:
        - Url: !Sub '${S3FilePathA}'
      RoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/MediaLiveAccessRole

  MediaLiveInputB2:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub '${ChannelName2}-prod'
      Type: MP4_FILE
      Sources:
        - Url: !Sub '${S3FilePathB}'
      RoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/MediaLiveAccessRole

  # Add inputs for channel 3
  MediaLiveInputA3:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub '${ChannelName3}-slate'
      Type: MP4_FILE
      Sources:
        - Url: !Sub '${S3FilePathA}'
      RoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/MediaLiveAccessRole

  MediaLiveInputB3:
    Type: AWS::MediaLive::Input
    Properties:
      Name: !Sub '${ChannelName3}-prod'
      Type: MP4_FILE
      Sources:
        - Url: !Sub '${S3FilePathB}'
      RoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/MediaLiveAccessRole

      
  MediaPackageV2ChannelGroup:
    Type: AWS::MediaPackageV2::ChannelGroup
    Properties:
      ChannelGroupName: !Ref ChannelGroupName

  # Create 3 MediaPackage Channels
  MediaPackageV2Channel1:
    Type: AWS::MediaPackageV2::Channel
    Properties:
      ChannelGroupName: !Ref ChannelGroupName
      ChannelName: !Ref ChannelName1
      InputType: 'CMAF'
    DependsOn:
      - MediaPackageV2ChannelGroup

  MediaPackageV2Channel2:
    Type: AWS::MediaPackageV2::Channel
    Properties:
      ChannelGroupName: !Ref ChannelGroupName
      ChannelName: !Ref ChannelName2
      InputType: 'CMAF'
    DependsOn:
      - MediaPackageV2ChannelGroup

  MediaPackageV2Channel3:
    Type: AWS::MediaPackageV2::Channel
    Properties:
      ChannelGroupName: !Ref ChannelGroupName
      ChannelName: !Ref ChannelName3
      InputType: 'CMAF'
    DependsOn:
      - MediaPackageV2ChannelGroup
        
  # Create 3 MediaPackage Endpoints
  MediaPackageV2OriginEndpoint1:
    Type: AWS::MediaPackageV2::OriginEndpoint
    Properties:
      OriginEndpointName: !Ref EndpointName1
      ChannelGroupName: !Ref ChannelGroupName
      ChannelName: !Ref ChannelName1
      ContainerType: CMAF
      StartoverWindowSeconds: 1209600
      ForceEndpointErrorConfiguration:
        EndpointErrorConditions:
          - STALE_MANIFEST
          - INCOMPLETE_MANIFEST
      Segment: 
        SegmentDurationSeconds: 4
        SegmentName: segment
        TsUseAudioRenditionGroup: True
      HlsManifests: 
        - ManifestName: 'index'
          ManifestWindowSeconds: 60
          ProgramDateTimeIntervalSeconds: 4
    DependsOn:
      - MediaPackageV2Channel1

  MediaPackageV2OriginEndpoint2:
    Type: AWS::MediaPackageV2::OriginEndpoint
    Properties:
      OriginEndpointName: !Ref EndpointName2
      ChannelGroupName: !Ref ChannelGroupName
      ChannelName: !Ref ChannelName2
      ContainerType: CMAF
      StartoverWindowSeconds: 1209600
      ForceEndpointErrorConfiguration:
        EndpointErrorConditions:
          - STALE_MANIFEST
          - INCOMPLETE_MANIFEST
      Segment: 
        SegmentDurationSeconds: 4
        SegmentName: segment
        TsUseAudioRenditionGroup: True
      HlsManifests: 
        - ManifestName: 'index'
          ManifestWindowSeconds: 60
          ProgramDateTimeIntervalSeconds: 4
    DependsOn:
      - MediaPackageV2Channel2

  MediaPackageV2OriginEndpoint3:
    Type: AWS::MediaPackageV2::OriginEndpoint
    Properties:
      OriginEndpointName: !Ref EndpointName3
      ChannelGroupName: !Ref ChannelGroupName
      ChannelName: !Ref ChannelName3
      ContainerType: CMAF
      StartoverWindowSeconds: 1209600
      ForceEndpointErrorConfiguration:
        EndpointErrorConditions:
          - STALE_MANIFEST
          - INCOMPLETE_MANIFEST
      Segment: 
        SegmentDurationSeconds: 4
        SegmentName: segment
        TsUseAudioRenditionGroup: True
      HlsManifests: 
        - ManifestName: 'index'
          ManifestWindowSeconds: 60
          ProgramDateTimeIntervalSeconds: 4
    DependsOn:
      - MediaPackageV2Channel3

  MediaPackageV2OriginEndpointPolicy1:
    Type: AWS::MediaPackageV2::OriginEndpointPolicy
    Properties:
      OriginEndpointName: !Ref EndpointName1
      ChannelGroupName: !Ref ChannelGroupName
      ChannelName: !Ref ChannelName1
      Policy: !Sub |
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AllowPublicGetObjectAccess",
              "Effect": "Allow",
              "Principal": "*",
              "Action": [
                "mediapackagev2:GetHeadObject",
                "mediapackagev2:GetObject"
              ],
              "Resource": "arn:aws:mediapackagev2:${AWS::Region}:${AWS::AccountId}:channelGroup/${ChannelGroupName}/channel/${ChannelName1}/originEndpoint/${EndpointName1}"
            },
            {
              "Sid": "AllowMediaPackageHarvestObjectAccess",
              "Effect": "Allow",
              "Principal": {
                "Service": "mediapackagev2.amazonaws.com"
              },
              "Action": "mediapackagev2:HarvestObject",
              "Resource": "arn:aws:mediapackagev2:${AWS::Region}:${AWS::AccountId}:channelGroup/${ChannelGroupName}/channel/${ChannelName1}/originEndpoint/${EndpointName1}",
              "Condition": {
                "StringEquals": {
                  "AWS:SourceAccount": "${AWS::AccountId}"
                }
              }
            }
          ]
        }
    DependsOn:
      - MediaPackageV2OriginEndpoint1

  MediaPackageV2OriginEndpointPolicy2:
    Type: AWS::MediaPackageV2::OriginEndpointPolicy
    Properties:
      OriginEndpointName: !Ref EndpointName2
      ChannelGroupName: !Ref ChannelGroupName
      ChannelName: !Ref ChannelName2
      Policy: !Sub |
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AllowPublicGetObjectAccess",
              "Effect": "Allow",
              "Principal": "*",
              "Action": [
                "mediapackagev2:GetHeadObject",
                "mediapackagev2:GetObject"
              ],
              "Resource": "arn:aws:mediapackagev2:${AWS::Region}:${AWS::AccountId}:channelGroup/${ChannelGroupName}/channel/${ChannelName2}/originEndpoint/${EndpointName2}"
            },
            {
              "Sid": "AllowMediaPackageHarvestObjectAccess",
              "Effect": "Allow",
              "Principal": {
                "Service": "mediapackagev2.amazonaws.com"
              },
              "Action": "mediapackagev2:HarvestObject",
              "Resource": "arn:aws:mediapackagev2:${AWS::Region}:${AWS::AccountId}:channelGroup/${ChannelGroupName}/channel/${ChannelName2}/originEndpoint/${EndpointName2}",
              "Condition": {
                "StringEquals": {
                  "AWS:SourceAccount": "${AWS::AccountId}"
                }
              }
            }
          ]
        }
    DependsOn:
      - MediaPackageV2OriginEndpoint2

  MediaPackageV2OriginEndpointPolicy3:
    Type: AWS::MediaPackageV2::OriginEndpointPolicy
    Properties:
      OriginEndpointName: !Ref EndpointName3
      ChannelGroupName: !Ref ChannelGroupName
      ChannelName: !Ref ChannelName3
      Policy: !Sub |
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AllowPublicGetObjectAccess",
              "Effect": "Allow",
              "Principal": "*",
              "Action": [
                "mediapackagev2:GetHeadObject",
                "mediapackagev2:GetObject"
              ],
              "Resource": "arn:aws:mediapackagev2:${AWS::Region}:${AWS::AccountId}:channelGroup/${ChannelGroupName}/channel/${ChannelName3}/originEndpoint/${EndpointName3}"
            },
            {
              "Sid": "AllowMediaPackageHarvestObjectAccess",
              "Effect": "Allow",
              "Principal": {
                "Service": "mediapackagev2.amazonaws.com"
              },
              "Action": "mediapackagev2:HarvestObject",
              "Resource": "arn:aws:mediapackagev2:${AWS::Region}:${AWS::AccountId}:channelGroup/${ChannelGroupName}/channel/${ChannelName3}/originEndpoint/${EndpointName3}",
              "Condition": {
                "StringEquals": {
                  "AWS:SourceAccount": "${AWS::AccountId}"
                }
              }
            }
          ]
        }
    DependsOn:
      - MediaPackageV2OriginEndpoint3
      
  MediaLiveChannel1:
    Type: AWS::MediaLive::Channel
    Properties:
      Name: !Sub '${ChannelName1}'
      ChannelClass: SINGLE_PIPELINE
      LogLevel: DISABLED
      RoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/MediaLiveAccessRole
      InputAttachments:
        - InputAttachmentName: 'slate'
          InputId: !Ref MediaLiveInputA1
          InputSettings:
            AudioSelectors: []
            CaptionSelectors: []
            DeblockFilter: DISABLED
            DenoiseFilter: DISABLED
            FilterStrength: 1
            InputFilter: AUTO
            Smpte2038DataPreference: IGNORE
            SourceEndBehavior: LOOP
        - InputAttachmentName: 'prod'
          InputId: !Ref MediaLiveInputB1
          InputSettings:
            AudioSelectors: []
            CaptionSelectors: []
            DeblockFilter: DISABLED
            DenoiseFilter: DISABLED
            FilterStrength: 1
            InputFilter: AUTO
            Smpte2038DataPreference: IGNORE
            SourceEndBehavior: LOOP
      InputSpecification:
        Codec: AVC
        MaximumBitrate: MAX_20_MBPS
        Resolution: HD
      Destinations:
        - Id: mediapackage-destination
          Settings:
            - Url: !Select
              - 0
              - !GetAtt
                - MediaPackageV2Channel1
                - IngestEndpointUrls
      EncoderSettings:
        AudioDescriptions:
          - Name: audio
            AudioSelectorName: Default
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
        CaptionDescriptions: []
        GlobalConfiguration:
          InputEndAction: NONE
          OutputLockingMode: EPOCH_LOCKING
          OutputTimingSource: INPUT_CLOCK
          SupportLowFramerateInputs: DISABLED
        OutputGroups: 
          - OutputGroupSettings:
              CmafIngestGroupSettings:
                Destination:
                  DestinationRefId: mediapackage-destination
                SegmentLength: 1
                SegmentLengthUnits: SECONDS
            Outputs:
              - OutputName: 1080p5994
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: 1
                VideoDescriptionName: 1080p
              - OutputName: 720p5994
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: 2
                VideoDescriptionName: 720p
              - OutputName: 480p2997
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: 3
                VideoDescriptionName: 480p
              - OutputName: 240p2997
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: 4
                VideoDescriptionName: 240p
              - AudioDescriptionNames:
                  - audio
                OutputName: _audio
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: audio
        TimecodeConfig:
          Source: SYSTEMCLOCK
        VideoDescriptions:
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: SPECIFIED
                FramerateNumerator: 60000
                FramerateDenominator: 1001
                GopBReference: DISABLED
                GopClosedCadence: 1
                GopNumBFrames: 3
                GopSize: 30
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: HIGH
                MaxBitrate: 5000000
                NumRefFrames: 3
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: HIGH
                RateControlMode: QVBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 1
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeBurninSettings:
                  FontSize: MEDIUM_32
                  Position: TOP_CENTER
                  Prefix: !Ref TimecodeBurninPrefix
                TimecodeInsertion: PIC_TIMING_SEI
            Height: 1080
            Name: 1080p
            RespondToAfd: NONE
            Sharpness: 50
            ScalingBehavior: DEFAULT
            Width: 1920
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: SPECIFIED
                FramerateNumerator: 60000
                FramerateDenominator: 1001
                GopBReference: DISABLED
                GopClosedCadence: 1
                GopNumBFrames: 3
                GopSize: 30
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: HIGH
                MaxBitrate: 3000000
                NumRefFrames: 3
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: HIGH
                RateControlMode: QVBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 1
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeBurninSettings:
                  FontSize: MEDIUM_32
                  Position: TOP_CENTER
                  Prefix: !Ref TimecodeBurninPrefix
                TimecodeInsertion: PIC_TIMING_SEI
            Height: 720
            Name: 720p
            RespondToAfd: NONE
            Sharpness: 75
            ScalingBehavior: DEFAULT
            Width: 1280
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: SPECIFIED
                FramerateNumerator: 30000
                FramerateDenominator: 1001
                GopBReference: ENABLED
                GopClosedCadence: 1
                GopNumBFrames: 3
                GopSize: 30
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: HIGH
                MaxBitrate: 1500000
                NumRefFrames: 3
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: MAIN
                RateControlMode: QVBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 1
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeBurninSettings:
                  FontSize: MEDIUM_32
                  Position: TOP_CENTER
                  Prefix: !Ref TimecodeBurninPrefix
                TimecodeInsertion: PIC_TIMING_SEI
            Height: 480
            Name: 480p
            RespondToAfd: NONE
            Sharpness: 100
            ScalingBehavior: STRETCH_TO_OUTPUT
            Width: 854
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: SPECIFIED
                FramerateNumerator: 30000
                FramerateDenominator: 1001
                GopBReference: ENABLED
                GopClosedCadence: 1
                GopNumBFrames: 3
                GopSize: 30
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: HIGH
                MaxBitrate: 1500000
                NumRefFrames: 3
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: MAIN
                RateControlMode: QVBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 1
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeBurninSettings:
                  FontSize: EXTRA_SMALL_10
                  Position: TOP_CENTER
                  Prefix: !Ref TimecodeBurninPrefix
                TimecodeInsertion: PIC_TIMING_SEI
            Height: 240
            Name: 240p
            RespondToAfd: NONE
            Sharpness: 100
            ScalingBehavior: STRETCH_TO_OUTPUT
            Width: 426
    DependsOn:
      - MediaLiveInputA1
      - MediaLiveInputB1
      - MediaPackageV2ChannelGroup
      - MediaPackageV2Channel1
      - MediaPackageV2OriginEndpoint1

  MediaLiveChannel2:
    Type: AWS::MediaLive::Channel
    Properties:
      Name: !Sub '${ChannelName2}'
      ChannelClass: SINGLE_PIPELINE
      LogLevel: DISABLED
      RoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/MediaLiveAccessRole
      InputAttachments:
        - InputAttachmentName: 'slate'
          InputId: !Ref MediaLiveInputA2
          InputSettings:
            AudioSelectors: []
            CaptionSelectors: []
            DeblockFilter: DISABLED
            DenoiseFilter: DISABLED
            FilterStrength: 1
            InputFilter: AUTO
            Smpte2038DataPreference: IGNORE
            SourceEndBehavior: LOOP
        - InputAttachmentName: 'prod'
          InputId: !Ref MediaLiveInputB2
          InputSettings:
            AudioSelectors: []
            CaptionSelectors: []
            DeblockFilter: DISABLED
            DenoiseFilter: DISABLED
            FilterStrength: 1
            InputFilter: AUTO
            Smpte2038DataPreference: IGNORE
            SourceEndBehavior: LOOP
      InputSpecification:
        Codec: AVC
        MaximumBitrate: MAX_20_MBPS
        Resolution: HD
      Destinations:
        - Id: mediapackage-destination
          Settings:
            - Url: !Select
              - 0
              - !GetAtt
                - MediaPackageV2Channel2
                - IngestEndpointUrls
      EncoderSettings:
        AudioDescriptions:
          - Name: audio
            AudioSelectorName: Default
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
        CaptionDescriptions: []
        GlobalConfiguration:
          InputEndAction: NONE
          OutputLockingMode: EPOCH_LOCKING
          OutputTimingSource: INPUT_CLOCK
          SupportLowFramerateInputs: DISABLED
        OutputGroups: 
          - OutputGroupSettings:
              CmafIngestGroupSettings:
                Destination:
                  DestinationRefId: mediapackage-destination
                SegmentLength: 1
                SegmentLengthUnits: SECONDS
            Outputs:
              - OutputName: 1080p5994
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: 1
                VideoDescriptionName: 1080p
              - OutputName: 720p5994
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: 2
                VideoDescriptionName: 720p
              - OutputName: 480p2997
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: 3
                VideoDescriptionName: 480p
              - OutputName: 240p2997
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: 4
                VideoDescriptionName: 240p
              - AudioDescriptionNames:
                  - audio
                OutputName: _audio
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: audio
        TimecodeConfig:
          Source: SYSTEMCLOCK
        VideoDescriptions:
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: SPECIFIED
                FramerateNumerator: 60000
                FramerateDenominator: 1001
                GopBReference: DISABLED
                GopClosedCadence: 1
                GopNumBFrames: 3
                GopSize: 30
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: HIGH
                MaxBitrate: 5000000
                NumRefFrames: 3
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: HIGH
                RateControlMode: QVBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 1
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeBurninSettings:
                  FontSize: MEDIUM_32
                  Position: TOP_CENTER
                  Prefix: !Ref TimecodeBurninPrefix
                TimecodeInsertion: PIC_TIMING_SEI
            Height: 1080
            Name: 1080p
            RespondToAfd: NONE
            Sharpness: 50
            ScalingBehavior: DEFAULT
            Width: 1920
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: SPECIFIED
                FramerateNumerator: 60000
                FramerateDenominator: 1001
                GopBReference: DISABLED
                GopClosedCadence: 1
                GopNumBFrames: 3
                GopSize: 30
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: HIGH
                MaxBitrate: 3000000
                NumRefFrames: 3
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: HIGH
                RateControlMode: QVBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 1
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeBurninSettings:
                  FontSize: MEDIUM_32
                  Position: TOP_CENTER
                  Prefix: !Ref TimecodeBurninPrefix
                TimecodeInsertion: PIC_TIMING_SEI
            Height: 720
            Name: 720p
            RespondToAfd: NONE
            Sharpness: 75
            ScalingBehavior: DEFAULT
            Width: 1280
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: SPECIFIED
                FramerateNumerator: 30000
                FramerateDenominator: 1001
                GopBReference: ENABLED
                GopClosedCadence: 1
                GopNumBFrames: 3
                GopSize: 30
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: HIGH
                MaxBitrate: 1500000
                NumRefFrames: 3
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: MAIN
                RateControlMode: QVBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 1
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeBurninSettings:
                  FontSize: MEDIUM_32
                  Position: TOP_CENTER
                  Prefix: !Ref TimecodeBurninPrefix
                TimecodeInsertion: PIC_TIMING_SEI
            Height: 480
            Name: 480p
            RespondToAfd: NONE
            Sharpness: 100
            ScalingBehavior: STRETCH_TO_OUTPUT
            Width: 854
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: SPECIFIED
                FramerateNumerator: 30000
                FramerateDenominator: 1001
                GopBReference: ENABLED
                GopClosedCadence: 1
                GopNumBFrames: 3
                GopSize: 30
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: HIGH
                MaxBitrate: 1500000
                NumRefFrames: 3
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: MAIN
                RateControlMode: QVBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 1
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeBurninSettings:
                  FontSize: EXTRA_SMALL_10
                  Position: TOP_CENTER
                  Prefix: !Ref TimecodeBurninPrefix
                TimecodeInsertion: PIC_TIMING_SEI
            Height: 240
            Name: 240p
            RespondToAfd: NONE
            Sharpness: 100
            ScalingBehavior: STRETCH_TO_OUTPUT
            Width: 426
    DependsOn:
      - MediaLiveInputA2
      - MediaLiveInputB2
      - MediaPackageV2ChannelGroup
      - MediaPackageV2Channel2
      - MediaPackageV2OriginEndpoint2
      
  MediaLiveChannel3:
    Type: AWS::MediaLive::Channel
    Properties:
      Name: !Sub '${ChannelName3}'
      ChannelClass: SINGLE_PIPELINE
      LogLevel: DISABLED
      RoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/MediaLiveAccessRole
      InputAttachments:
        - InputAttachmentName: 'slate'
          InputId: !Ref MediaLiveInputA3
          InputSettings:
            AudioSelectors: []
            CaptionSelectors: []
            DeblockFilter: DISABLED
            DenoiseFilter: DISABLED
            FilterStrength: 1
            InputFilter: AUTO
            Smpte2038DataPreference: IGNORE
            SourceEndBehavior: LOOP
        - InputAttachmentName: 'prod'
          InputId: !Ref MediaLiveInputB3
          InputSettings:
            AudioSelectors: []
            CaptionSelectors: []
            DeblockFilter: DISABLED
            DenoiseFilter: DISABLED
            FilterStrength: 1
            InputFilter: AUTO
            Smpte2038DataPreference: IGNORE
            SourceEndBehavior: LOOP
      InputSpecification:
        Codec: AVC
        MaximumBitrate: MAX_20_MBPS
        Resolution: HD
      Destinations:
        - Id: mediapackage-destination
          Settings:
            - Url: !Select
              - 0
              - !GetAtt
                - MediaPackageV2Channel3
                - IngestEndpointUrls
      EncoderSettings:
        AudioDescriptions:
          - Name: audio
            AudioSelectorName: Default
            AudioTypeControl: FOLLOW_INPUT
            LanguageCodeControl: FOLLOW_INPUT
            CodecSettings:
              AacSettings:
                InputType: NORMAL
                Bitrate: 128000
                CodingMode: CODING_MODE_2_0
                RawFormat: NONE
                Spec: MPEG4
                Profile: LC
                RateControlMode: CBR
                SampleRate: 48000
        CaptionDescriptions: []
        GlobalConfiguration:
          InputEndAction: NONE
          OutputLockingMode: EPOCH_LOCKING
          OutputTimingSource: INPUT_CLOCK
          SupportLowFramerateInputs: DISABLED
        OutputGroups: 
          - OutputGroupSettings:
              CmafIngestGroupSettings:
                Destination:
                  DestinationRefId: mediapackage-destination
                SegmentLength: 1
                SegmentLengthUnits: SECONDS
            Outputs:
              - OutputName: 1080p5994
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: 1
                VideoDescriptionName: 1080p
              - OutputName: 720p5994
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: 2
                VideoDescriptionName: 720p
              - OutputName: 480p2997
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: 3
                VideoDescriptionName: 480p
              - OutputName: 240p2997
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: 4
                VideoDescriptionName: 240p
              - AudioDescriptionNames:
                  - audio
                OutputName: _audio
                OutputSettings:
                  CmafIngestOutputSettings:
                    NameModifier: audio
        TimecodeConfig:
          Source: SYSTEMCLOCK
        VideoDescriptions:
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: SPECIFIED
                FramerateNumerator: 60000
                FramerateDenominator: 1001
                GopBReference: DISABLED
                GopClosedCadence: 1
                GopNumBFrames: 3
                GopSize: 30
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: HIGH
                MaxBitrate: 5000000
                NumRefFrames: 3
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: HIGH
                RateControlMode: QVBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 1
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeBurninSettings:
                  FontSize: MEDIUM_32
                  Position: TOP_CENTER
                  Prefix: !Ref TimecodeBurninPrefix
                TimecodeInsertion: PIC_TIMING_SEI
            Height: 1080
            Name: 1080p
            RespondToAfd: NONE
            Sharpness: 50
            ScalingBehavior: DEFAULT
            Width: 1920
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: SPECIFIED
                FramerateNumerator: 60000
                FramerateDenominator: 1001
                GopBReference: DISABLED
                GopClosedCadence: 1
                GopNumBFrames: 3
                GopSize: 30
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: HIGH
                MaxBitrate: 3000000
                NumRefFrames: 3
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: HIGH
                RateControlMode: QVBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 1
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeBurninSettings:
                  FontSize: MEDIUM_32
                  Position: TOP_CENTER
                  Prefix: !Ref TimecodeBurninPrefix
                TimecodeInsertion: PIC_TIMING_SEI
            Height: 720
            Name: 720p
            RespondToAfd: NONE
            Sharpness: 75
            ScalingBehavior: DEFAULT
            Width: 1280
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: SPECIFIED
                FramerateNumerator: 30000
                FramerateDenominator: 1001
                GopBReference: ENABLED
                GopClosedCadence: 1
                GopNumBFrames: 3
                GopSize: 30
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: HIGH
                MaxBitrate: 1500000
                NumRefFrames: 3
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: MAIN
                RateControlMode: QVBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 1
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeBurninSettings:
                  FontSize: MEDIUM_32
                  Position: TOP_CENTER
                  Prefix: !Ref TimecodeBurninPrefix
                TimecodeInsertion: PIC_TIMING_SEI
            Height: 480
            Name: 480p
            RespondToAfd: NONE
            Sharpness: 100
            ScalingBehavior: STRETCH_TO_OUTPUT
            Width: 854
          - CodecSettings:
              H264Settings:
                AfdSignaling: NONE
                ColorMetadata: INSERT
                AdaptiveQuantization: HIGH
                EntropyEncoding: CABAC
                FlickerAq: DISABLED
                ForceFieldPictures: DISABLED
                FramerateControl: SPECIFIED
                FramerateNumerator: 30000
                FramerateDenominator: 1001
                GopBReference: ENABLED
                GopClosedCadence: 1
                GopNumBFrames: 3
                GopSize: 30
                GopSizeUnits: FRAMES
                SubgopLength: DYNAMIC
                ScanType: PROGRESSIVE
                Level: H264_LEVEL_AUTO
                LookAheadRateControl: HIGH
                MaxBitrate: 1500000
                NumRefFrames: 3
                ParControl: SPECIFIED
                ParNumerator: 1
                ParDenominator: 1
                Profile: MAIN
                RateControlMode: QVBR
                Syntax: DEFAULT
                SceneChangeDetect: ENABLED
                Slices: 1
                SpatialAq: ENABLED
                TemporalAq: ENABLED
                TimecodeBurninSettings:
                  FontSize: EXTRA_SMALL_10
                  Position: TOP_CENTER
                  Prefix: !Ref TimecodeBurninPrefix
                TimecodeInsertion: PIC_TIMING_SEI
            Height: 240
            Name: 240p
            RespondToAfd: NONE
            Sharpness: 100
            ScalingBehavior: STRETCH_TO_OUTPUT
            Width: 426
    DependsOn:
      - MediaLiveInputA3
      - MediaLiveInputB3
      - MediaPackageV2ChannelGroup
      - MediaPackageV2Channel3
      - MediaPackageV2OriginEndpoint3

Outputs:    
  MediaPackageV2CmafIngest0:
    Description: "Cmaf Ingest endpoint 1"
    Value: !Select
      - 0
      - !GetAtt MediaPackageV2Channel1.IngestEndpointUrls
          
  MediaPackageV2CmafIngest1:
    Description: "Cmaf Ingest endpoint 2"
    Value: !Select
      - 1
      - !GetAtt MediaPackageV2Channel1.IngestEndpointUrls

  MediaPackageV2HLS:
    Description: "Hls endpoint url"
    Value:  !Select
      - 0
      - !GetAtt MediaPackageV2OriginEndpoint1.HlsManifestUrls   
      
  MediaPackageDomain:
    Description: "Egress Domain"
    Value: !GetAtt MediaPackageV2ChannelGroup.EgressDomain
